#!/bin/sh
# Pre-commit hook to run KtLint, Detekt, and Unit Tests

echo "ğŸš€ Running Pre-commit checks..."

# 1. KTLINT FORMAT
echo "ğŸ¨ Running KtLint Format..."
# Get list of staged Kotlin files
STAGED_KOTLIN_FILES=$(git diff --name-only --cached --diff-filter=ACMR | grep ".kt$")

if [ -n "$STAGED_KOTLIN_FILES" ]; then
    ./gradlew ktlintFormat
    if [ $? -ne 0 ]; then
        echo "âŒ KtLint formatting failed."
        echo "   ğŸ‘‰ Check console output for details."
        exit 1
    fi
    # Add formatted files back to staging
    echo "$STAGED_KOTLIN_FILES" | xargs git add
else
    echo "â„¹ï¸ No Kotlin files staged. Skipping KtLint."
fi

# 2. DETEKT
echo "ğŸ” Running Detekt..."
./gradlew detekt
if [ $? -ne 0 ]; then
    echo "âŒ Detekt found issues."
    echo "   ğŸ“„ Report: build/reports/detekt/detekt.html"
    exit 1
fi

# 3. CODE COVERAGE VERIFICATION (80% Threshold)
echo "ğŸ§ª Verifying Code Coverage..."
# Run verification for App/Data (Android) and Domain (JVM)
./gradlew verifyJacocoCoverage :domain:testCoverageVerification
if [ $? -ne 0 ]; then
    echo "âŒ Code Coverage verification failed (<80%)."
    echo "   ğŸ‘‰ Please add more tests to cover your changes."
    echo "   ğŸ“„ App Report: app/build/reports/jacoco/testDebugUnitTestCoverage/html/index.html"
    echo "   ğŸ“„ Doamin Report: domain/build/reports/jacoco/testCoverage/html/index.html"
    exit 1
fi

echo "âœ… All checks passed!"
exit 0
