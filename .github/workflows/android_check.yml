name: Android CI

on:
    push:
        branches: [ "main" ]
    pull_request:
        types: [ opened, synchronize, reopened ]
        branches: [ "main" ]

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

env:
    JAVA_VERSION: "21"
    JAVA_DISTRIBUTION: "temurin"
    GRADLE_OPTS: "-Dorg.gradle.caching=true"

jobs:
    # =========================================================================
    # Build Job - Compiles the project and caches artifacts for downstream jobs
    # =========================================================================
    build:
        name: ðŸ—ï¸ Build
        runs-on: ubuntu-latest
        outputs:
            build-status: ${{ steps.build.outcome }}
        steps:
            -   name: ðŸ“¥ Checkout code
                uses: actions/checkout@v4

            -   name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
                uses: actions/setup-java@v4
                with:
                    java-version: ${{ env.JAVA_VERSION }}
                    distribution: ${{ env.JAVA_DISTRIBUTION }}

            -   name: ðŸ“¦ Setup Gradle
                uses: gradle/actions/setup-gradle@v4
                with:
                    cache-read-only: false

            -   name: ðŸ”‘ Grant execute permission for gradlew
                run: chmod +x gradlew

            -   name: ðŸ—ï¸ Build Debug APK
                id: build
                run: |
                    echo "::group::Building Debug APK"
                    ./gradlew assembleDebug --build-cache
                    echo "::endgroup::"
                    echo "âœ… Build completed successfully!"

            -   name: ðŸ“Š Build Summary
                run: |
                    echo "## ðŸ—ï¸ Build Summary" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
                    echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
                    echo "| Status | âœ… Success |" >> $GITHUB_STEP_SUMMARY
                    echo "| APK Size | $(du -h app/build/outputs/apk/debug/*.apk | cut -f1) |" >> $GITHUB_STEP_SUMMARY
                    echo "| Java Version | ${{ env.JAVA_VERSION }} |" >> $GITHUB_STEP_SUMMARY

            -   name: ðŸ“¤ Upload build artifacts
                uses: actions/upload-artifact@v4
                with:
                    name: build-artifacts
                    path: |
                        app/build/outputs/apk/debug/
                    retention-days: 1

    # =========================================================================
    # Lint Job - Static analysis checks (runs in parallel)
    # =========================================================================
    lint:
        name: ðŸ” Lint & Static Analysis
        runs-on: ubuntu-latest
        needs: build
        steps:
            -   name: ðŸ“¥ Checkout code
                uses: actions/checkout@v4

            -   name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
                uses: actions/setup-java@v4
                with:
                    java-version: ${{ env.JAVA_VERSION }}
                    distribution: ${{ env.JAVA_DISTRIBUTION }}

            -   name: ðŸ“¦ Setup Gradle
                uses: gradle/actions/setup-gradle@v4
                with:
                    cache-read-only: true

            -   name: ðŸ”‘ Grant execute permission for gradlew
                run: chmod +x gradlew

            -   name: ðŸ”Ž Run Detekt
                id: detekt
                run: |
                    echo "::group::Running Detekt Analysis"
                    ./gradlew detekt --build-cache
                    echo "::endgroup::"
                    echo "âœ… Detekt passed!"

            -   name: ðŸ“ Run KtLint
                id: ktlint
                run: |
                    echo "::group::Running KtLint Check"
                    ./gradlew ktlintCheck --build-cache
                    echo "::endgroup::"
                    echo "âœ… KtLint passed!"

            -   name: ðŸ“± Run Android Lint
                id: lint
                run: |
                    echo "::group::Running Android Lint"
                    ./gradlew lintDebug --build-cache
                    echo "::endgroup::"
                    echo "âœ… Android Lint passed!"

            -   name: ðŸ“Š Lint Summary
                if: always()
                run: |
                    echo "## ðŸ” Static Analysis Summary" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "| Tool | Status |" >> $GITHUB_STEP_SUMMARY
                    echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
                    echo "| Detekt | ${{ steps.detekt.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
                    echo "| KtLint | ${{ steps.ktlint.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
                    echo "| Android Lint | ${{ steps.lint.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY

            -   name: ðŸ“¤ Upload Lint Reports
                if: always()
                uses: actions/upload-artifact@v4
                with:
                    name: lint-reports
                    path: |
                        **/build/reports/detekt/
                        **/build/reports/ktlint/
                        **/build/reports/lint-results-*.html
                        **/build/reports/lint-results-*.xml
                    retention-days: 7

    # =========================================================================
    # Unit Test Job - Runs unit tests with coverage
    # =========================================================================
    test:
        name: ðŸ§ª Unit Tests
        runs-on: ubuntu-latest
        needs: build
        steps:
            -   name: ðŸ“¥ Checkout code
                uses: actions/checkout@v4

            -   name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
                uses: actions/setup-java@v4
                with:
                    java-version: ${{ env.JAVA_VERSION }}
                    distribution: ${{ env.JAVA_DISTRIBUTION }}

            -   name: ðŸ“¦ Setup Gradle
                uses: gradle/actions/setup-gradle@v4
                with:
                    cache-read-only: true

            -   name: ðŸ”‘ Grant execute permission for gradlew
                run: chmod +x gradlew

            -   name: ðŸ§ª Run Unit Tests with Coverage
                id: unit-tests
                run: |
                    echo "::group::Running Unit Tests"
                    ./gradlew testDebugUnitTest :domain:test testDebugUnitTestCoverage --build-cache
                    echo "::endgroup::"
                    echo "âœ… All unit tests passed!"

            -   name: ðŸ“Š Parse and Display Test Summary
                if: always()
                run: |
                    echo "## ðŸ§ª Unit Test Results" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY

                    # Count test results from XML files
                    TOTAL_TESTS=0
                    PASSED_TESTS=0
                    FAILED_TESTS=0
                    SKIPPED_TESTS=0

                    for xml in $(find . -path "*/build/test-results/*/TEST-*.xml" -type f 2>/dev/null); do
                      tests=$(grep -o 'tests="[0-9]*"' "$xml" | head -1 | grep -o '[0-9]*' || echo 0)
                      failures=$(grep -o 'failures="[0-9]*"' "$xml" | head -1 | grep -o '[0-9]*' || echo 0)
                      errors=$(grep -o 'errors="[0-9]*"' "$xml" | head -1 | grep -o '[0-9]*' || echo 0)
                      skipped=$(grep -o 'skipped="[0-9]*"' "$xml" | head -1 | grep -o '[0-9]*' || echo 0)

                      TOTAL_TESTS=$((TOTAL_TESTS + tests))
                      FAILED_TESTS=$((FAILED_TESTS + failures + errors))
                      SKIPPED_TESTS=$((SKIPPED_TESTS + skipped))
                    done
                    PASSED_TESTS=$((TOTAL_TESTS - FAILED_TESTS - SKIPPED_TESTS))

                    echo "### Test Execution" >> $GITHUB_STEP_SUMMARY
                    echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
                    echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
                    echo "| âœ… Passed | $PASSED_TESTS |" >> $GITHUB_STEP_SUMMARY
                    echo "| âŒ Failed | $FAILED_TESTS |" >> $GITHUB_STEP_SUMMARY
                    echo "| â­ï¸ Skipped | $SKIPPED_TESTS |" >> $GITHUB_STEP_SUMMARY
                    echo "| ðŸ“Š Total | $TOTAL_TESTS |" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY

                    # Show failed tests if any
                    if [ "$FAILED_TESTS" -gt 0 ]; then
                      echo "### âŒ Failed Tests" >> $GITHUB_STEP_SUMMARY
                      echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                      for xml in $(find . -path "*/build/test-results/*/TEST-*.xml" -type f 2>/dev/null); do
                        grep -l 'failures="[1-9]' "$xml" 2>/dev/null | while read f; do
                          grep -oP 'classname="\K[^"]+' "$f" | head -3
                        done
                      done | sort -u | head -10 >> $GITHUB_STEP_SUMMARY
                      echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                      echo "" >> $GITHUB_STEP_SUMMARY
                    fi

                    # Parse JaCoCo coverage
                    echo "### ðŸ“Š Code Coverage" >> $GITHUB_STEP_SUMMARY
                    echo "| Module | Line Coverage | Branch Coverage |" >> $GITHUB_STEP_SUMMARY
                    echo "|--------|---------------|-----------------|" >> $GITHUB_STEP_SUMMARY

                    for module in app domain data; do
                      JACOCO_FILE=$(find . -path "*/$module/build/reports/jacoco/*/*.xml" -type f 2>/dev/null | head -1)
                      if [ -f "$JACOCO_FILE" ]; then
                        # Extract line coverage
                        COVERED=$(grep -oP 'type="LINE"[^/]*covered="\K[0-9]+' "$JACOCO_FILE" | tail -1 || echo 0)
                        MISSED=$(grep -oP 'type="LINE"[^/]*missed="\K[0-9]+' "$JACOCO_FILE" | tail -1 || echo 0)
                        TOTAL=$((COVERED + MISSED))
                        if [ "$TOTAL" -gt 0 ]; then
                          LINE_PCT=$((COVERED * 100 / TOTAL))
                        else
                          LINE_PCT=0
                        fi

                        # Extract branch coverage
                        BR_COVERED=$(grep -oP 'type="BRANCH"[^/]*covered="\K[0-9]+' "$JACOCO_FILE" | tail -1 || echo 0)
                        BR_MISSED=$(grep -oP 'type="BRANCH"[^/]*missed="\K[0-9]+' "$JACOCO_FILE" | tail -1 || echo 0)
                        BR_TOTAL=$((BR_COVERED + BR_MISSED))
                        if [ "$BR_TOTAL" -gt 0 ]; then
                          BRANCH_PCT=$((BR_COVERED * 100 / BR_TOTAL))
                        else
                          BRANCH_PCT="N/A"
                        fi

                        # Add color indicators
                        if [ "$LINE_PCT" -ge 80 ]; then
                          LINE_ICON="ðŸŸ¢"
                        elif [ "$LINE_PCT" -ge 50 ]; then
                          LINE_ICON="ðŸŸ¡"
                        else
                          LINE_ICON="ðŸ”´"
                        fi

                        echo "| $module | $LINE_ICON $LINE_PCT% | $BRANCH_PCT% |" >> $GITHUB_STEP_SUMMARY
                      else
                        echo "| $module | âšª N/A | N/A |" >> $GITHUB_STEP_SUMMARY
                      fi
                    done
                    echo "" >> $GITHUB_STEP_SUMMARY

                    # Show classes with low coverage (< 50%)
                    echo "<details>" >> $GITHUB_STEP_SUMMARY
                    echo "<summary>ðŸ“‹ Classes Needing Tests (< 50% coverage)</summary>" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "| Class | Coverage |" >> $GITHUB_STEP_SUMMARY
                    echo "|-------|----------|" >> $GITHUB_STEP_SUMMARY

                    for xml in $(find . -path "*/build/reports/jacoco/*/*.xml" -type f 2>/dev/null); do
                      # Parse each class element and calculate coverage
                      grep -oP '<class name="[^"]+[^>]+>' "$xml" 2>/dev/null | while read class_line; do
                        class_name=$(echo "$class_line" | grep -oP 'name="\K[^"]+' | sed 's/\//./g')
                        # Get the next LINE counter after this class
                        covered=$(echo "$class_line" | grep -oP 'covered="\K[0-9]+' | head -1 || echo 0)
                        missed=$(echo "$class_line" | grep -oP 'missed="\K[0-9]+' | head -1 || echo 0)
                        total=$((covered + missed))
                        if [ "$total" -gt 0 ]; then
                          pct=$((covered * 100 / total))
                          if [ "$pct" -lt 50 ]; then
                            echo "| \`${class_name##*.}\` | ðŸ”´ $pct% |"
                          fi
                        fi
                      done
                    done | head -10 >> $GITHUB_STEP_SUMMARY

                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "</details>" >> $GITHUB_STEP_SUMMARY

            -   name: ðŸ“¤ Upload Test Reports
                if: always()
                uses: actions/upload-artifact@v4
                with:
                    name: test-reports
                    path: |
                        **/build/reports/tests/
                        **/build/reports/jacoco/
                        **/build/test-results/
                    retention-days: 7

            -   name: ðŸ“Š Publish Coverage Report
                if: github.event_name == 'pull_request'
                uses: madrapps/jacoco-report@50d3aff4548aa991e6753342d9ba291084e63848 # v1.7.2
                with:
                    paths: |
                        ${{ github.workspace }}/app/build/reports/jacoco/testDebugUnitTestCoverage/testDebugUnitTestCoverage.xml
                        ${{ github.workspace }}/domain/build/reports/jacoco/testDebugUnitTestCoverage/testDebugUnitTestCoverage.xml
                    token: ${{ secrets.GITHUB_TOKEN }}
                    min-coverage-overall: 40
                    min-coverage-changed-files: 60
                    title: "ðŸ“Š Code Coverage Report"

    # =========================================================================
    # Screenshot Test Job - Visual regression testing with Roborazzi
    # =========================================================================
    screenshot:
        name: ðŸ“¸ Screenshot Tests
        runs-on: ubuntu-latest
        needs: build
        steps:
            -   name: ðŸ“¥ Checkout code
                uses: actions/checkout@v4

            -   name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
                uses: actions/setup-java@v4
                with:
                    java-version: ${{ env.JAVA_VERSION }}
                    distribution: ${{ env.JAVA_DISTRIBUTION }}

            -   name: ðŸ“¦ Setup Gradle
                uses: gradle/actions/setup-gradle@v4
                with:
                    cache-read-only: true

            -   name: ðŸ”‘ Grant execute permission for gradlew
                run: chmod +x gradlew

            -   name: ðŸ“¸ Verify Screenshots (Roborazzi)
                id: screenshots
                run: |
                    echo "::group::Verifying Screenshots"
                    ./gradlew verifyRoborazziDebug --build-cache
                    echo "::endgroup::"
                    echo "âœ… All screenshots match!"

            -   name: ðŸ“Š Screenshot Summary
                if: always()
                run: |
                    echo "## ðŸ“¸ Screenshot Test Summary" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
                    echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
                    echo "| Visual Regression | ${{ steps.screenshots.outcome == 'success' && 'âœ… No changes detected' || 'âš ï¸ Differences found' }} |" >> $GITHUB_STEP_SUMMARY

            -   name: ðŸ“¤ Upload Screenshot Diffs
                if: failure()
                uses: actions/upload-artifact@v4
                with:
                    name: screenshot-diffs
                    path: "**/build/outputs/roborazzi/**"
                    retention-days: 7

    # =========================================================================
    # Instrumentation Test Job - Runs on Android Emulator
    # =========================================================================
    instrumentation:
        name: ðŸ“± Instrumentation Tests
        runs-on: ubuntu-latest
        needs: build
        steps:
            -   name: ðŸ“¥ Checkout code
                uses: actions/checkout@v4

            -   name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
                uses: actions/setup-java@v4
                with:
                    java-version: ${{ env.JAVA_VERSION }}
                    distribution: ${{ env.JAVA_DISTRIBUTION }}

            -   name: ðŸ“¦ Setup Gradle
                uses: gradle/actions/setup-gradle@v4
                with:
                    cache-read-only: true

            -   name: ðŸ”‘ Grant execute permission for gradlew
                run: chmod +x gradlew

            -   name: ðŸ”§ Enable KVM
                run: |
                    echo "Enabling KVM for faster emulator..."
                    echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
                    sudo udevadm control --reload-rules
                    sudo udevadm trigger --name-match=kvm
                    echo "âœ… KVM enabled!"

            -   name: ðŸ“± Run Instrumentation Tests
                uses: reactivecircus/android-emulator-runner@v2
                with:
                    api-level: 30
                    target: aosp_atd
                    arch: x86_64
                    disable-animations: true
                    script: |
                        echo "::group::Running Instrumentation Tests"
                        ./gradlew connectedDebugAndroidTest --build-cache
                        echo "::endgroup::"

            -   name: ðŸ“Š Instrumentation Summary
                if: always()
                run: |
                    echo "## ðŸ“± Instrumentation Summary" >> $GITHUB_STEP_SUMMARY
                    echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
                    echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
                    echo "| Image | AOSP ATD (API 30) |" >> $GITHUB_STEP_SUMMARY
                    echo "| Status | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY

            -   name: ðŸ“¤ Upload Instrumentation Reports
                if: always()
                uses: actions/upload-artifact@v4
                with:
                    name: instrumentation-reports
                    path: "**/build/reports/androidTests/"
                    retention-days: 7

    # =========================================================================
    # SonarCloud Analysis Job
    # =========================================================================
    sonar:
        name: ðŸ”Ž SonarCloud Analysis
        runs-on: ubuntu-latest
        needs: [ lint, test, instrumentation ]
        if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
        steps:
            -   name: ðŸ“¥ Checkout code
                uses: actions/checkout@v4
                with:
                    fetch-depth: 0

            -   name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
                uses: actions/setup-java@v4
                with:
                    java-version: ${{ env.JAVA_VERSION }}
                    distribution: ${{ env.JAVA_DISTRIBUTION }}
                    cache: gradle

            -   name: ðŸ“¦ Setup Gradle
                uses: gradle/actions/setup-gradle@v4
                with:
                    cache-read-only: true

            -   name: ðŸ”‘ Grant execute permission for gradlew
                run: chmod +x gradlew

            -   name: ðŸ“¥ Download Test Reports
                uses: actions/download-artifact@v4
                with:
                    name: test-reports
                    path: .

            -   name: ðŸ“¥ Download Lint Reports
                uses: actions/download-artifact@v4
                with:
                    name: lint-reports
                    path: .

            -   name: ðŸ“¥ Download Instrumentation Reports
                uses: actions/download-artifact@v4
                with:
                    name: instrumentation-reports
                    path: .

            -   name: ðŸ”Ž Run SonarCloud Analysis
                id: sonar
                env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                    SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
                    SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
                    SONAR_ORGANIZATION_KEY: ${{ secrets.SONAR_ORGANIZATION_KEY }}
                run: |
                    echo "::group::Running SonarCloud Analysis"
                    ./gradlew assembleDebug sonar --info --build-cache
                    echo "::endgroup::"
                    echo "âœ… SonarCloud analysis complete!"
                continue-on-error: true

            -   name: ðŸ“Š SonarCloud Summary
                if: always()
                run: |
                    echo "## ðŸ”Ž SonarCloud Summary" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "| Metric | Status |" >> $GITHUB_STEP_SUMMARY
                    echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
                    echo "| Analysis | ${{ steps.sonar.outcome == 'success' && 'âœ… Completed' || 'âš ï¸ Skipped or Failed' }} |" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "ðŸ”— [View Dashboard](https://sonarcloud.io/dashboard?id=${{ secrets.SONAR_PROJECT_KEY }})" >> $GITHUB_STEP_SUMMARY
